sedikit）＋し（akhiran）"],
    ["ぜんぜん","","zenzen","sama sekali (negatif)","ekspresi","全（zen, semua）＋然（zen, bentuk）"],
    ["はやく","早く","hayaku","cepat / lebih awal","ekspresi","早（haya, cepat）＋く（akhiran）"],
    ["〜から","","〜kara","karena / dari","partikel",""],
    ["どうして","","dōshite","kenapa / mengapa","kata tanya",""],
    ["ざんねんです[ね]","残念です[ね]","zannen desu[ne]","sayang sekali","ekspresi","残（zan, sisa）＋念（nen, perasaan）"],
    ["すみません","","sumimasen","maaf / permisi","ekspresi","済（sumi, selesai）＋ません（negatif sopan）"],
    ["もしもし","","moshimoshi","halo (telepon)","ekspresi",""],
    ["ああ","","aa","oh / ya","ekspresi",""],
    ["いっしょに いかがですか","","issho ni ikaga desu ka","bagaimana kalau bersama","ekspresi",""],
    ["〜は ちょっと……","","〜wa chotto...","hmm, agak susah / maaf","ekspresi",""],
    ["だめですか","","dame desu ka","tidak boleh / tidak bisa ya?","ekspresi",""],
    ["また こんど おねがいします","","mata kondo onegai shimasu","lain kali saja","ekspresi","また（lagi）＋今度（kondo, kali ini）＋お願いします（onegai shimasu, tolong）"]
  ],
10: [
    ["あります","","arimasu","ada (benda mati)","verba","有（ari, ada）＋ます（bentuk sopan）"],
    ["います","","imasu","ada (makhluk hidup)","verba","居（i, berada）＋ます"],
    ["いろいろ[な]","","iroiro[na]","bermacam-macam","kata sifat-na",""],
    ["おとこの ひと","男の人","otoko no hito","laki-laki","orang","男（otoko, laki）＋人（hito, orang）"],
    ["おんなの ひと","女の人","onna no hito","perempuan","orang","女（onna, perempuan）＋人（hito, orang）"],
    ["おとこの こ","男の子","otoko no ko","anak laki-laki","orang","男（otoko, laki）＋子（ko, anak）"],
    ["おんなの こ","女の子","onna no ko","anak perempuan","orang","女（onna, perempuan）＋子（ko, anak）"],
    ["いぬ","犬","inu","anjing","benda","犬（inu, anjing）"],
    ["ねこ","猫","neko","kucing","benda","猫（neko, kucing）"],
    ["き","木","ki","pohon","benda","木（ki, pohon）"],
    ["もの","物","mono","barang / benda","benda","物（mono, benda）"],
    ["フィルム","","firumu","film","benda",""],
    ["でんち","電池","denchi","baterai","benda","電（den, listrik）＋池（chi, kolam / sel）"],
    ["はこ","箱","hako","kotak","benda","箱（hako, kotak）"],
    ["スイッチ","","suicchi","saklar","benda",""],
    ["れいぞうこ","冷蔵庫","reizōko","lemari es","benda","冷（rei, dingin）＋蔵（zō, simpan）＋庫（ko, gudang）"],
    ["テーブル","","tēburu","meja","benda",""],
    ["ベッド","","beddo","tempat tidur","benda",""],
    ["たな","棚","tana","rak","benda","棚（tana, rak）"],
    ["ドア","","doa","pintu","benda",""],
    ["まど","窓","mado","jendela","benda","窓（mado, jendela）"],
    ["ポスト","","posuto","kotak pos","benda",""],
    ["ビル","","biru","gedung / bangunan","tempat",""],
    ["こうえん","公園","kōen","taman","tempat","公（kō, umum）＋園（en, taman）"],
    ["きっさてん","喫茶店","kissaten","kedai kopi","tempat","喫（kissa, minum）＋茶（cha, teh）＋店（ten, toko）"],
    ["ほんや","本屋","honya","toko buku","tempat","本（hon, buku）＋屋（ya, toko）"],
    ["〜や","","〜ya","toko〜","tempat","屋（ya, toko）"],
    ["のりば","乗り場","noriba","tempat naik kendaraan","tempat","乗（nori, naik）＋場（ba, tempat）"],
    ["けん","県","ken","prefektur","tempat","県（ken, provinsi）"],
    ["うえ","上","ue","atas","arah","上（ue, atas）"],
    ["した","下","shita","bawah","arah","下（shita, bawah）"],
    ["まえ","前","mae","depan","arah","前（mae, depan）"],
    ["うしろ","後ろ","ushiro","belakang","arah","後（ushi, belakang）＋ろ（akhiran）"],
    ["みぎ","右","migi","kanan","arah","右（migi, kanan）"],
    ["ひだり","左","hidari","kiri","arah","左（hidari, kiri）"],
    ["なか","中","naka","dalam","arah","中（naka, dalam）"],
    ["そと","外","soto","luar","arah","外（soto, luar）"],
    ["となり","隣","tonari","sebelah / tetangga","arah","隣（tonari, sebelah）"],
    ["ちかく","近く","chikaku","dekat / sekitar","arah","近（chika, dekat）＋く（akhiran）"],
    ["あいだ","間","aida","antara","arah","間（aida, antara）"],
    ["〜や〜（など）","","〜ya〜 (nado)","〜dan〜 (dll)","penghubung",""],
    ["いちばん〜","","ichiban〜","yang paling〜","penegas","一番（ichiban, nomor satu）"],
    ["〜だんめ","〜段目","〜danme","rak ke〜 (tingkat)","penunjuk","段（dan, tingkat）＋目（me, urutan）"],
    ["［どうも］すみません","","(dōmo) sumimasen","terima kasih / maaf","ekspresi",""],
    ["チリス","","Chirisu","Chile","negara",""],
    ["スペイン","","Supein","Spanyol","negara",""]
  ],
};

/* ==========================
   LOGIKA UMUM
   ========================== */
let currentLesson=1;
let data=semuaBab[1]||[];
let order=[],known=new Set();let index=0;

const $=s=>document.querySelector(s);
const els={lesson:$('#lesson'),filter:$('#filter'),onlyUnknown:$('#onlyUnknown'),
card:$('#card'),front:$('#front'),back:$('#back'),
jpFront:$('#jpFront'),romajiFront:$('#romajiFront'),
meaningBack:$('#meaningBack'),kanjiBack:$('#kanjiBack'),
btnPrev:$('#btnPrev'),btnNext:$('#btnNext'),btnKnown:$('#btnKnown'),
btnShuffle:$('#btnShuffle'),btnResetKnown:$('#btnResetKnown'),
btnResetProgress:$('#btnResetProgress'),bar:$('#bar'),
count:$('#count'),knownCount:$('#knownCount'),
badgeCat:$('#badgeCat'),badgeKnown:$('#badgeKnown')};

function storageKey(base){return`mnn${currentLesson}_${base}`;}

function initLesson(){
  data = semuaBab[currentLesson] || [];
  order=[...data.keys()];
  const knownRaw=localStorage.getItem(storageKey('known'));
  known=new Set(knownRaw?JSON.parse(knownRaw):[]);
  index=Math.min(Number(localStorage.getItem(storageKey('idx'))||0),order.length-1);
  const cats=[...new Set(data.map(d=>d[4]))];
  els.filter.innerHTML='<option value="all">Semua</option>'+cats.map(c=>`<option value="${c}">${c[0].toUpperCase()+c.slice(1)}</option>`).join('');
  render();
}

function saveKnown(){localStorage.setItem(storageKey('known'),JSON.stringify([...known]));}
function saveIdx(){localStorage.setItem(storageKey('idx'),String(index));}
function updateKnownCount(){els.knownCount.textContent=known.size;}

function pool(){
 const cat=els.filter.value,only=els.onlyUnknown?.checked;
 const arr=order.filter(i=>(cat==='all'||data[i][4]===cat)&&(!only||!known.has(i)));
 return arr.length?arr:order.filter(i=>(cat==='all'||data[i][4]===cat));
}

function render(){
 if(!data.length){els.jpFront.textContent='(Kosong)';els.romajiFront.textContent='';
 els.meaningBack.textContent='';return;}
 const p=pool();let gid=order[index];
 if(!p.includes(gid)){gid=p[0];index=order.indexOf(gid);}
 const [kana,kanji,romaji,arti,kat,analisis]=data[gid];
 els.jpFront.textContent=kana;els.romajiFront.textContent=romaji;
 els.meaningBack.textContent=arti;
 if(kanji&&analisis){els.kanjiBack.style.display='';els.kanjiBack.innerHTML=`Kanji: ${kanji} = ${analisis}`;}
 else{els.kanjiBack.style.display='none';els.kanjiBack.innerHTML='';}
 els.badgeCat.textContent=(kat||'-').toUpperCase();
 els.badgeKnown.classList.toggle('show',known.has(gid));
 els.front.style.display='';els.back.style.display='none';
 const pos=p.indexOf(gid);els.count.textContent=`Kartu ${pos+1}/${p.length}`;
 els.bar.style.width=`${((pos+1)/p.length)*100}%`;updateKnownCount();
}

function flip(){
 const showBack=els.back.style.display==='none';
 els.back.style.display=showBack?'':'none';els.front.style.display=showBack?'none':'';
}
function toggleKnown(){const gid=order[index];
 if(known.has(gid))known.delete(gid);else known.add(gid);
 saveKnown();render();}
const ANIM_MS=220;let isAnimating=false;
function go(dir){
  if(isAnimating) return;
  const p = pool();
  const gid = order[index];
  let pos = p.indexOf(gid);

  // kalau data tidak sinkron, reset posisi
  if (pos === -1) pos = 0;

  let targetIndex = pos;
  if (dir === 'next' && pos < p.length - 1) targetIndex = pos + 1;
  if (dir === 'prev' && pos > 0) targetIndex = pos - 1;

  const t = p[targetIndex];
  if (t == null) return;

  isAnimating = true;
  els.card.classList.remove('anim-in-left','anim-in-right','anim-out-left','anim-out-right');
  els.card.offsetWidth;

  els.card.classList.add(dir === 'next' ? 'anim-out-left' : 'anim-out-right');
  setTimeout(() => {
    index = order.indexOf(t);
    if (index < 0) index = 0; // kalau tidak ketemu, fallback ke awal
    saveIdx();
    render();

    els.card.classList.remove('anim-out-left','anim-out-right');
    els.card.offsetWidth;
    els.card.clanim-out-left'r === 'next' ? 'anim-in-right' : 'anim-in-left');

    setTimeout(() => {
      els.card.classList.remove('anim-in-left','anim-in-right');
      isAnimating = false;
    }, ANIM_MS);
  }, ANIM_MS);
}
function next(){go('next');}
function prev(){go('prev');}

els.btnNext.onclick=next;
els.btnPrev.onclick=prev;
els.btnKnown.onclick=toggleKnown;
els.btnShuffle.onclick=()=>{order=[...order].sort(()=>Math.random()-.5);render();};
els.btnResetKnown.onclick=()=>{if(confirm('Hapus semua penanda hafal bab ini?')){known.clear();saveKnown();render();}};
els.btnResetProgress.onclick=()=>{index=0;saveIdx();render();setTimeouttur */
let sx=0,sy=0,t0=0,last=0;
els.card.addEventListener('touchstart',e=>{const t=e.changedTouches[0];sx=t.clientX;sy=t.clientY;t0=Date.now();},{passive:true});
els.card.addEventListener('touchend',e=>{
 const t=e.changedTouches[0];const dx=t.clientX-sx,dy=t.clientY-sy,dt=Date.now()-t0;
 const now=Date.now();if(now-last<250){toggleKnown();last=0;return;}last=now;
 if(Math.abs(dx)>50&&Math.abs(dx)>Math.abs(dy)){dx<0?next():prev();return;}
 if(dt<300&&Math.abs(dx)<10&&Math.abs(dy)<10){flip();}
},{passive:true});

/* Ganti bab */
els.lesson.onchange=()=>{currentLesson=Number(els.lesson.value);initLesson();};

/* ✅ Pastikan saat pertama kali halaman dibuka, currentLesson sudah terset dan langsung panggil initLesson() */
window.addEventListener('DOMContentLoaded',()=>{currentLesson=Number(els.lesson.value);initLesson();});
</script>
</body>
</html>
